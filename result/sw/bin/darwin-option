#! /nix/store/nravshvfviv75plf26nwfwzg8ldl3z8s-bash-5.2p37/bin/bash
set -e
set -o pipefail

export PATH=/nix/store/bcdc67d3d3jkbl35ccxmvyan5kmic9lc-coreutils-9.7/bin:/nix/store/04gj0cpc6mv0pkyz114p23fq65zx8mbx-jq-1.8.0-bin/bin:/nix/store/ir2bhb7n3ngh0dg7p6jbhm1wa4d8gkb7-git-2.49.0/bin:/nix/store/zln77pckyb4ky96vb4vqq6flgiifvbcy-nix-2.28.3/bin:$HOME/.nix-profile/bin:/etc/profiles/per-user/$USER/bin:/run/current-system/sw/bin:/nix/var/nix/profiles/default/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
export NIX_PATH=${NIX_PATH:-nixpkgs=flake:nixpkgs:/nix/var/nix/profiles/per-user/root/channels}

evalNix() {
  nix-instantiate --eval --strict "${extraEvalFlags[@]}" -E "with import <darwin> {}; $*" 2>/dev/null
}

evalOpt() {
  evalNix "options.$option.$*"
}

evalOptAttrs() {
  evalNix "builtins.concatStringsSep \"\\n\" (builtins.attrNames $*)" | jq -r .
}

evalOptText() {
  evalNix "options.$option.$*" | jq -r .
}

showSyntax() {
  echo "$0: [-I path] <option>" >&2
  evalOptAttrs "options"
  exit 1
}

# Parse the command line.
origArgs=("$@")
extraEvalFlags=()
option=

while [ "$#" -gt 0 ]; do
  i="$1"; shift 1
  case "$i" in
    --help)
      showSyntax
      ;;
    -I)
      if [ -z "$1" ]; then
        echo "$0: ‘$i’ requires an argument"
        exit 1
      fi
      j="$1"; shift 1
      extraEvalFlags+=("$i" "$j")
      ;;
    *)
      option="$i"
      ;;
  esac
done

if [ -z "$option" ]; then showSyntax; fi

if [ "$(evalOpt "_type")" = '"option"' ]; then
  echo "Value:"
  evalOpt "value" || echo "no value"
  echo
  echo "Default:"
  evalOpt "default" || evalOptText "defaultText" || echo "no default"
  echo
  echo "Example:"
  if [ "$(evalOpt "example._type")" = '"literalExpression"' ]; then
    evalOptText "example.text" || echo "no example"
  else
    evalOpt "example" || echo "no example"
  fi
  echo
  echo "Description:"
  evalOptText "description.text" || echo "no description"
  echo
else
  evalOptAttrs "options.$option"
fi
