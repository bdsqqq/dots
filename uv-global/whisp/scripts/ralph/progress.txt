# Build Progress Log
Started: 2026-01-17
Feature: whisp - audio to markdown transcription
Parent Task: 1

## Task Dependency Graph

```
P0 (2) ─┬─► P1a (3) ─┐
        ├─► P1b (4) ─┤
        ├─► P1c (5) ─┤
        ├─► P1d (6) ─┼─► P4 (12) ─► P5 (13) ─► P6 (14)
        ├─► P1e (7) ─┤
        ├─► P2a (8) ─┤
        ├─► P2b (9) ─┤
        ├─► P3a (10)─┤
        └─► P3b (11)─┘
```

execution order: 2 → (3,4,5,6,7,8,9,10,11 parallel) → 12 → 13 → 14

## Codebase Patterns
(patterns discovered during this feature build)

- flat layout: whisp/ is directly under uv-global/, NOT uv-global/whisp/whisp/
- pyproject.toml lives in uv-global/, uses `packages = ["whisp"]` in hatch config

---

## 2026-01-17 - P0: package skeleton ✅ COMPLETED
Thread: https://ampcode.com/threads/T-019bce5b-37a7-75a9-9c87-a6ae489f4d11
Task ID: 2
- implemented package skeleton with all required files
- files created:
  - whisp/__init__.py (version='0.1.0', __all__ exports)
  - whisp/__main__.py (stub main())
  - whisp/py.typed (PEP 561 marker)
  - whisp/models.py (Word, SpeakerTurn, Transcript dataclasses)
  - whisp/errors.py (WhispError base + 6 subclasses with exit codes)
- **Learnings for future iterations:**
  - package lives at uv-global/whisp/, not nested uv-global/whisp/whisp/
  - pyproject.toml is in parent dir (uv-global/), not whisp/
  - uv run whisp works immediately after file creation (editable install)
  - task_list tool not available in context; track completion in progress.txt
---

## 2026-01-17 - P1a: timefmt.py ✅ COMPLETED
Thread: https://ampcode.com/threads/T-019bce5d-3029-7608-81a8-82deb2dc4257
Task ID: 3
- implemented timefmt.py with format_timestamp and format_duration
- files created:
  - whisp/timefmt.py
  - whisp/timefmt_test.py (17 tests, all passing)
- updated __init__.py exports
- **Learnings:**
  - no type checker (pyright/mypy) installed; rely on pytest + python -c imports
---

## 2026-01-17 - P1b: filename.py ✅ COMPLETED
Thread: https://ampcode.com/threads/T-019bce5d-3029-7608-81a8-82deb2dc4257
Task ID: 4
- implemented filename.py with get_source_timestamp, sanitize_filename, make_output_filename
- format: YYYY-MM-DDTHH-MM <original-name> -- source__transcript.md
- files created:
  - whisp/filename.py
  - whisp/filename_test.py (12 tests, all passing)
- updated __init__.py exports
---

## 2026-01-17 - P1c: segment.py ✅ COMPLETED
Thread: https://ampcode.com/threads/T-019bce5d-3029-7608-81a8-82deb2dc4257
Task ID: 5
- implemented segment.py with words_to_turns function
- breaks on speaker change OR gap > threshold (default 1.5s)
- None speakers mapped to UNKNOWN
- files created:
  - whisp/segment.py
  - whisp/segment_test.py (10 tests, all passing)
- updated __init__.py exports
---

## 2026-01-17 - P1d: align.py ✅ COMPLETED
Thread: https://ampcode.com/threads/T-019bce5d-3029-7608-81a8-82deb2dc4257
Task ID: 6
- implemented align.py with assign_speakers function
- midpoint assignment: word → speaker whose segment contains word midpoint
- no match → UNKNOWN
- uses dataclasses.replace() to avoid mutation
- files created:
  - whisp/align.py
  - whisp/align_test.py (10 tests with MockDiarization, all passing)
- updated __init__.py exports
---

## 2026-01-17 - P1e: format_md.py ✅ COMPLETED
Thread: https://ampcode.com/threads/T-019bce5d-3029-7608-81a8-82deb2dc4257
Task ID: 7
- implemented format_md.py with render function
- YAML frontmatter with source, duration, speakers, model, transcribed
- single_speaker mode: empty speakers list, no labels in body
- empty audio: [...silence]
- UNKNOWN labels shown for diarization failure
- files created:
  - whisp/format_md.py
  - whisp/format_md_test.py (11 tests, all passing)
- updated __init__.py exports
- total tests: 60 passing
---

## 2026-01-17 - P2a: transcribe_fw.py ✅ COMPLETED
Thread: https://ampcode.com/threads/T-019bce5d-3029-7608-81a8-82deb2dc4257
Task ID: 8
- implemented faster-whisper adapter
- detect_device: cuda if available, else cpu (mps → cpu)
- get_default_model: cuda → large-v3/float16, cpu → medium/int8
- transcribe: always word_timestamps=True, returns (words, duration)
- proper error wrapping: ModelLoadError, TranscriptionError
- files created:
  - whisp/transcribe_fw.py
  - whisp/transcribe_fw_test.py (13 tests, mocked faster_whisper)
- **Learnings:**
  - mock faster_whisper.WhisperModel with create=True (import inside function)
---

## 2026-01-17 - P2b: diarize_pyannote.py ✅ COMPLETED
Thread: https://ampcode.com/threads/T-019bce5d-3029-7608-81a8-82deb2dc4257
Task ID: 9
- implemented pyannote diarization adapter
- check_hf_token: checks HF_TOKEN or HUGGING_FACE_HUB_TOKEN, raises HFTokenMissingError
- diarize: loads pyannote/speaker-diarization-3.1, supports speakers_hint
- files created:
  - whisp/diarize_pyannote.py
  - whisp/diarize_pyannote_test.py (11 tests, mocked pyannote.audio.Pipeline)
- **Learnings:**
  - pyannote.audio imported lazily; mock with create=True
  - torchcodec warning in tests (ffmpeg not linked) — doesn't affect mocked tests
---

## 2026-01-17 - P3a: validate.py ✅ COMPLETED
Thread: https://ampcode.com/threads/T-019bce5d-3029-7608-81a8-82deb2dc4257
Task ID: 10
- implemented validate.py
- validate_file_exists: checks existence + is_file, returns resolved Path
- validate_ffmpeg_decodable: runs ffprobe, handles missing ffprobe/timeout
- files created:
  - whisp/validate.py
  - whisp/validate_test.py (10 tests, all passing)
- **Learnings:**
  - whisp.errors.FileNotFoundError shadows builtin; use OSError with errno check for subprocess errors
---

## 2026-01-17 - P3b: io.py ✅ COMPLETED
Thread: https://ampcode.com/threads/T-019bce5d-3029-7608-81a8-82deb2dc4257
Task ID: 11
- implemented io.py
- write_stdout: writes to stdout with newline handling
- atomic_write: temp file + rename, optional .partial on failure
- files created:
  - whisp/io.py
  - whisp/io_test.py (12 tests, all passing)
- total tests: 106 passing
---
